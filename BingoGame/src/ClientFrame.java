import java.awt.BorderLayout; 
import java.awt.event.KeyEvent; 
import java.awt.event.KeyListener; 
import java.io.BufferedReader; 
import java.io.BufferedWriter; 
import java.io.IOException; 
import java.io.InputStreamReader; 
import java.io.OutputStream; 
import java.io.OutputStreamWriter; 
import java.net.Socket;
import java.util.ArrayList;

import javax.swing.JFrame; 
import javax.swing.JScrollPane; 
import javax.swing.JTextArea; 
import javax.swing.JTextField; 

public class ClientFrame extends JFrame{ 
   //자유롭게 사용하려면 여기에 필드로 선언해야 한다 
   //채팅창 프레임을 구성하는 컴포넌트 
   //textarea 한줄 이상의 문자 입력 보여주기 
   private JTextArea textarea; 
   private JTextField sendMsgTf; 
   private JScrollPane scrollPane;
   
   //서버와의 통신을 위한 소켓 
   private Socket socket;
   private BufferedWriter bw; 
   
   public static ArrayList <Integer> numbers = new ArrayList<Integer>(); 
   
   public ClientFrame() { 
      textarea = new JTextArea(); 
      sendMsgTf = new JTextField(); 
      textarea.setEditable(false);
      scrollPane = new JScrollPane(textarea, JScrollPane.VERTICAL_SCROLLBAR_ALWAYS, JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);

      setSize(400, 600); 
      setLocation(750, 100);
      setAlwaysOnTop(true);
      setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE); 
      
      setTitle("chatting"); 
      
      sendMsgTf.addKeyListener(new MsgSendListener()); 
      add(scrollPane,BorderLayout.EAST);
      add(textarea,BorderLayout.CENTER);
      add(sendMsgTf,BorderLayout.SOUTH);
      setVisible(true); 
   } 
   //소켓 설정을 위한 세터 
   //이제 프레임도 소켓의 정보를 가지게 되었다 
   public void setSocket(Socket socket) { 
      this.socket = socket; 
      try { 
         OutputStream out = socket.getOutputStream(); 
         bw = new BufferedWriter(new OutputStreamWriter(out));
      } catch (Exception e) { 
         e.printStackTrace(); 
      }
   } 
   
   public boolean isCalled(int value)
    {
        for (int x : numbers) {
            if (value == (int) x)
                return true;
        }
        return false;
    }
   
   //내부 클래스로 이벤트 리스너 만들기
   class MsgSendListener implements KeyListener { 
      @Override public void keyTyped(KeyEvent e) { 
      
      }@Override public void keyPressed(KeyEvent e) { 
         
      }@Override public void keyReleased(KeyEvent e) {
         //키가 눌렸다가 떼어졌을때 
         //엔터키가 눌렸다가 떼어지면 텍스트 필드에 있는 내용이 텍스트 에어리어에 나타나게 
         if (e.getKeyCode()==KeyEvent.VK_ENTER) {
            //각각의 키들이 가지고 있는 코드 값이 나타난다 
            //VK_ENTER = 상수 , 엔터 키에 대한 키값을 의미한다 
            String msg = sendMsgTf.getText(); 
            System.out.println(msg);
            if(!isCalled(Integer.parseInt(msg))) {
               textarea.append("[ 나 ]: "+msg+"\n"); 
               numbers.add(Integer.parseInt(msg));
               sendMsgTf.setText(""); 
               try { 
                  bw.write(msg+"\n"); 
                  bw.flush(); 
               } catch (IOException e1) { 
                  // TODO Auto-generated catch block 
                  e1.printStackTrace(); 
               }
               //한문장이 끝났다는 것을 알리기 위해서 bufferedWriter에 "\n"을 붙인다
            }
            else {
               textarea.append("이미 불린 숫자입니다. 다시 입력하세요.\n");
            }
         }
      } 
   } 
   //내부 클래스로 수신 스레드 작성 
   class TcpClientReceiveThread implements Runnable { 
      private Socket socket;
      public TcpClientReceiveThread(Socket socket) { 
         this.socket = socket; 
      } 
      @Override public void run() { 
         //서버로부터 오는 메세지를 읽어서 
         //텍스트 에어리어에 추가하기 
         try { 
            BufferedReader br = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            while (true) { 
               String msg = br.readLine();
               //메세지 한줄 읽어오기
               textarea.append("[상대방]" + msg + "\n");
               numbers.add(Integer.parseInt(msg));

               for(int i : numbers) {
                  System.out.println((int)i);
               }
            } 
         } catch (Exception e) { 
            textarea.append("연결이 종료되었습니다."); 
            //System.out.println("연결이 종료되었습니다."); 
         } finally { 
            try { 
               if (socket!=null&&!socket.isClosed()) { 
                  socket.close();//다 쓴 소켓 닫기 
               } 
            } catch (Exception e2) { 
               
            } 
         } 
      } 
   } 
   public static void main(String[] args) { 
      try {         
         Runplease run = new Runplease();
         
         //서버 아이피 , 포트번호 -> 소켓 생성 -> 연결 요청
         Socket socket = new Socket("192.168.0.7", 5000); 
         //소켓 객체 생성
         ClientFrame cf = new ClientFrame(); 
         cf.setSocket(socket);
         //메인에서 프레임 생성
         TcpClientReceiveThread th1 = cf.new TcpClientReceiveThread(socket); 
         //TcpClientReceiveThread가 내부 클래스로 선언되어 있기 때문에
         //cf로 접근해서 socket을 전달한다
         new Thread(th1).start();
            
      } catch (Exception e) { 
         e.printStackTrace(); 
      } 
   } 
}